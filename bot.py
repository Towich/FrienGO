import asyncio
import logging
import os
from typing import List, Optional

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application, CommandHandler, CallbackQueryHandler, 
    ContextTypes, MessageHandler, filters
)
from telegram.constants import ParseMode

from models import User, VoteStatus
from database import DatabaseManager
from voting import VotingService
from scheduler import PingScheduler


class FrienGoBot:
    """–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å —Ç–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–∞ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–π –æ –≤—Å—Ç—Ä–µ—á–∞—Ö"""
    
    def __init__(self, token: str, db_path: str = "friendgo.db"):
        self.token = token
        self.db = DatabaseManager(db_path)
        self.voting_service = VotingService(self.db)
        self.scheduler = PingScheduler(self.db, self.voting_service)
        self.application = Application.builder().token(token).build()
        self.logger = logging.getLogger(__name__)
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
        self.scheduler.set_ping_callback(self._send_ping_message)
        
        self._setup_handlers()
    
    def _setup_handlers(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥ –∏ callback'–æ–≤"""
        # –ö–æ–º–∞–Ω–¥—ã
        self.application.add_handler(CommandHandler("start", self.start_command))
        self.application.add_handler(CommandHandler("help", self.help_command))
        self.application.add_handler(CommandHandler("vote", self.create_voting_command))
        self.application.add_handler(CommandHandler("ping", self.ping_command))
        self.application.add_handler(CommandHandler("status", self.status_command))
        
        # Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        self.application.add_handler(CallbackQueryHandler(self.handle_callback))
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
        self.application.add_error_handler(self.error_handler)
    
    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
        user = update.effective_user
        if user:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
            db_user = User(
                user_id=user.id,
                username=user.username,
                first_name=user.first_name,
                last_name=user.last_name
            )
            self.db.save_user(db_user)
        
        welcome_text = (
            "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç FrienGO –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤—Å—Ç—Ä–µ—á —Å –¥—Ä—É–∑—å—è–º–∏!\n\n"
            "üó≥ –ò—Å–ø–æ–ª—å–∑—É–π /vote —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –æ –¥–Ω—è—Ö –≤—Å—Ç—Ä–µ—á–∏\n"
            "üìä –ò—Å–ø–æ–ª—å–∑—É–π /status —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â–µ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ\n"
            "üì¢ –ò—Å–ø–æ–ª—å–∑—É–π /ping —á—Ç–æ–±—ã –Ω–∞–ø–æ–º–Ω–∏—Ç—å –¥—Ä—É–∑—å—è–º –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å\n"
            "‚ùì –ò—Å–ø–æ–ª—å–∑—É–π /help –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–π —Å–ø—Ä–∞–≤–∫–∏\n\n"
            "–ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –≤–∞—à—É –≤—Å—Ç—Ä–µ—á—É! üöÄ"
        )
        
        await update.message.reply_text(welcome_text)
    
    async def help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
        help_text = (
            "üìñ **–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º FrienGO –±–æ—Ç–∞**\n\n"
            "**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**\n"
            "üó≥ `/vote` - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –æ –¥–Ω—è—Ö –≤—Å—Ç—Ä–µ—á–∏\n"
            "üìä `/status` - –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –∞–∫—Ç–∏–≤–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ\n"
            "üì¢ `/ping` - –ù–∞–ø–æ–º–Ω–∏—Ç—å –Ω–µ–ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–≤—à–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º\n\n"
            "**–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:**\n"
            "1Ô∏è‚É£ –°–æ–∑–¥–∞–π—Ç–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π `/vote`\n"
            "2Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –¥–Ω–∏, –Ω–∞–∂–∏–º–∞—è –Ω–∞ –∫–Ω–æ–ø–∫–∏\n"
            "3Ô∏è‚É£ –ú–æ–∂–µ—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —Å–≤–æ–π –≥–æ–ª–æ—Å, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ\n"
            "4Ô∏è‚É£ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/ping` —á—Ç–æ–±—ã –Ω–∞–ø–æ–º–Ω–∏—Ç—å –¥—Ä—É–∑—å—è–º\n\n"
            "**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:**\n"
            "‚è∞ –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–ø–æ–º–Ω–∏—Ç —á–µ—Ä–µ–∑ 24, 48 –∏ 72 —á–∞—Å–∞\n\n"
            "**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**\n"
            "‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä –¥–Ω–µ–π\n"
            "üîÑ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω—ã –≥–æ–ª–æ—Å–∞\n"
            "üìä –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Å—á–µ—Ç –≥–æ–ª–æ—Å–æ–≤\n"
            "üë• –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–≤—à–∏—Ö\n\n"
            "–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è! üéâ"
        )
        
        await update.message.reply_text(help_text, parse_mode=ParseMode.MARKDOWN)
    
    async def create_voting_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /vote - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è"""
        chat_id = update.effective_chat.id
        user = update.effective_user
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if user:
            db_user = User(
                user_id=user.id,
                username=user.username,
                first_name=user.first_name,
                last_name=user.last_name
            )
            self.db.save_user(db_user)
        
        try:
            # –°–æ–∑–¥–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
            voting = self.voting_service.create_voting(chat_id)
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
            message_text = self._format_voting_message(voting.voting_id)
            keyboard = self._create_voting_keyboard(voting.voting_id, user.id)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            sent_message = await update.message.reply_text(
                message_text,
                reply_markup=keyboard,
                parse_mode=ParseMode.MARKDOWN
            )
            
            # –û–±–Ω–æ–≤–ª—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ë–î
            self.db.update_voting_message_id(voting.voting_id, sent_message.message_id)
            
        except ValueError as e:
            await update.message.reply_text(f"‚ùå {str(e)}")
        except Exception as e:
            self.logger.error(f"Error creating voting: {e}")
            await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è")
    
    async def status_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /status - –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è"""
        chat_id = update.effective_chat.id
        
        voting = self.voting_service.get_active_voting(chat_id)
        if not voting:
            await update.message.reply_text("üìù –í –¥–∞–Ω–Ω–æ–º —á–∞—Ç–µ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è.\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /vote –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ!")
            return
        
        message_text = self._format_voting_message(voting.voting_id)
        keyboard = self._create_voting_keyboard(voting.voting_id, update.effective_user.id if update.effective_user else None)
        
        await update.message.reply_text(
            message_text,
            reply_markup=keyboard,
            parse_mode=ParseMode.MARKDOWN
        )
    
    async def ping_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /ping - –Ω–∞–ø–æ–º–Ω–∏—Ç—å –Ω–µ–ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–≤—à–∏–º"""
        chat_id = update.effective_chat.id
        
        voting = self.voting_service.get_active_voting(chat_id)
        if not voting:
            await update.message.reply_text("üìù –í –¥–∞–Ω–Ω–æ–º —á–∞—Ç–µ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è.")
            return
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–∞—Ç–∞
        chat_users = self.db.get_chat_users(chat_id)
        non_voted_users = self.voting_service.get_non_voted_users(voting.voting_id, chat_users)
        
        result = await self.scheduler.send_manual_ping(chat_id, voting.voting_id, non_voted_users)
        await update.message.reply_text(result)
    
    async def handle_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ inline –∫–Ω–æ–ø–∫–∏"""
        query = update.callback_query
        await query.answer()
        
        user = update.effective_user
        if not user:
            return
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        db_user = User(
            user_id=user.id,
            username=user.username,
            first_name=user.first_name,
            last_name=user.last_name
        )
        self.db.save_user(db_user)
        
        # –ü–∞—Ä—Å–∏–º callback data
        try:
            action, voting_id, option_id = query.data.split(":")
            voting_id = int(voting_id)
            option_id = int(option_id)
        except ValueError:
            await query.edit_message_text("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ")
            return
        
        if action == "vote":
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            voting = self.db.get_voting(voting_id)
            if not voting:
                await query.answer("–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ", show_alert=True)
                return
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–æ–ª–æ—Å–æ–≤–∞–ª –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞ —ç—Ç—É –æ–ø—Ü–∏—é
            if voting.has_user_voted_for_option(user.id, option_id):
                # –ï—Å–ª–∏ —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª - –æ—Ç–º–µ–Ω—è–µ–º –≥–æ–ª–æ—Å
                success, message = self.voting_service.remove_vote(user.id, option_id, voting_id)
                if success:
                    await self._update_voting_message(query, voting_id, user.id)
                    await query.answer("–ì–æ–ª–æ—Å –æ—Ç–º–µ–Ω–µ–Ω")
                else:
                    await query.answer(message, show_alert=True)
            else:
                # –ï—Å–ª–∏ –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª - –¥–æ–±–∞–≤–ª—è–µ–º –≥–æ–ª–æ—Å
                success, message = self.voting_service.vote_for_option(user.id, option_id, voting_id)
                
                if success:
                    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    await self._update_voting_message(query, voting_id, user.id)
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≥–æ–ª–æ—Å–µ
                    await self._send_vote_notification(update.effective_chat.id, user, voting_id)
                else:
                    await query.answer(message, show_alert=True)
    
    async def _update_voting_message(self, query, voting_id: int, user_id: int = None):
        """–û–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ–º"""
        message_text = self._format_voting_message(voting_id)
        keyboard = self._create_voting_keyboard(voting_id, user_id)
        
        try:
            await query.edit_message_text(
                message_text,
                reply_markup=keyboard,
                parse_mode=ParseMode.MARKDOWN
            )
        except Exception as e:
            self.logger.error(f"Error updating voting message: {e}")
    
    async def _send_vote_notification(self, chat_id: int, user, voting_id: int):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª"""
        stats = self.voting_service.get_voting_stats(voting_id)
        if not stats:
            return
        
        user_name = user.first_name or user.username or f"User_{user.id}"
        message = (f"‚úÖ {user_name} –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª!\n"
                  f"üìä –ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–æ: {stats['voted_users']}/{stats['total_users']}")
        
        try:
            await self.application.bot.send_message(chat_id, message)
        except Exception as e:
            self.logger.error(f"Error sending vote notification: {e}")
    
    def _format_voting_message(self, voting_id: int) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ–º"""
        stats = self.voting_service.get_voting_stats(voting_id)
        if not stats:
            return "–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
        
        message = f"üó≥ **{stats['title']}**\n\n"
        
        for option in stats['options']:
            votes_emoji = "‚úÖ" * option['votes_count'] if option['votes_count'] > 0 else ""
            message += f"{option['description']}: {option['votes_count']} –≥–æ–ª–æ—Å–æ–≤ {votes_emoji}\n"
        
        message += f"\nüìä –ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–æ: {stats['voted_users']}/{stats['total_users']}"
        
        return message
    
    def _create_voting_keyboard(self, voting_id: int, user_id: int = None) -> InlineKeyboardMarkup:
        """–°–æ–∑–¥–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è"""
        voting = self.db.get_voting(voting_id)
        if not voting:
            return InlineKeyboardMarkup([])
        
        keyboard = []
        for option in voting.options:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–æ–ª–æ—Å–æ–≤–∞–ª –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞ —ç—Ç—É –æ–ø—Ü–∏—é
            user_voted = False
            if user_id and voting.has_user_voted_for_option(user_id, option.option_id):
                user_voted = True
            
            # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è/–æ—Ç–º–µ–Ω—ã –≥–æ–ª–æ—Å–∞
            vote_emoji = "‚úÖ" if user_voted else "‚¨ú"
            button_text = f"{vote_emoji} {option.description}"
            callback_data = f"vote:{voting_id}:{option.option_id}"
            
            button = InlineKeyboardButton(button_text, callback_data=callback_data)
            keyboard.append([button])
        
        return InlineKeyboardMarkup(keyboard)
    
    async def _send_ping_message(self, chat_id: int, voting_id: int, message: str):
        """Callback —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ ping —Å–æ–æ–±—â–µ–Ω–∏–π"""
        try:
            await self.application.bot.send_message(chat_id, message)
        except Exception as e:
            self.logger.error(f"Error sending ping message: {e}")
    
    async def error_handler(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
        self.logger.error(f"Update {update} caused error {context.error}")
    
    async def start_bot(self):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"""
        self.logger.info("Starting FrienGO bot...")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –≤ —Ñ–æ–Ω–µ
        asyncio.create_task(self.scheduler.start())
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
        await self.application.initialize()
        await self.application.start()
        await self.application.updater.start_polling()
        
        self.logger.info("FrienGO bot started successfully!")
    
    async def stop_bot(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞"""
        self.logger.info("Stopping FrienGO bot...")
        
        self.scheduler.stop()
        await self.application.updater.stop()
        await self.application.stop()
        await self.application.shutdown()
        
        self.logger.info("FrienGO bot stopped") 